# ====================================
# Render.com Blueprint - MindfulMe Platform
# ====================================
# Complete production deployment configuration for Render.com
# This file defines all services, databases, and configurations
# 
# DEPLOYMENT URL STRUCTURE:
# - Backend:  https://mindfulme-backend.onrender.com
# - Frontend: https://mindfulme-frontend.onrender.com
# - Database: Internal connection (auto-configured)
#
# Before deploying:
# 1. Update CORS_ORIGIN in backend service (line 45)
# 2. Update VITE_API_URL in frontend service (line 123)
# 3. Set secrets in Render dashboard (JWT_SECRET, etc.)
# 4. Review database migration strategy (line 64)
# ====================================

services:
  # ============================================================
  # BACKEND API SERVICE
  # ============================================================
  - type: web
    name: mindfulme-backend
    runtime: node
    region: oregon # Options: oregon, frankfurt, singapore, ohio, virginia
    plan: free # Options: free (512MB, sleeps after inactivity), starter ($7/mo, 512MB), standard ($25/mo, 2GB)
    branch: main # Deploy from this branch
    
    # Build Configuration
    buildCommand: |
      npm install &&
      npm run build:shared &&
      npm run build -w backend &&
      echo "‚úÖ Backend build complete" &&
      echo "üìä Running database migrations..." &&
      cd backend && npx drizzle-kit push || echo "‚ö†Ô∏è Migration skipped (will retry on startup)" &&
      cd .. &&
      echo "‚úÖ Setup complete"
    
    # Start Configuration  
    startCommand: npm run start:prod -w backend
    
    # Environment Variables
    envVars:
      # === CORE CONFIGURATION ===
      - key: NODE_ENV
        value: production
      
      - key: PORT
        value: 5000
      
      # === DATABASE ===
      - key: DATABASE_URL
        fromDatabase:
          name: mindfulme-postgres
          property: connectionString
      
      - key: USE_SQLITE
        value: "false"
      
      - key: USE_NEON
        value: "true" # Set to true if using Neon PostgreSQL
      
      # === AUTHENTICATION & SECURITY ===
      - key: JWT_SECRET
        generateValue: true # Render auto-generates secure 256-bit secret
        sync: false
      
      - key: JWT_REFRESH_SECRET
        generateValue: true
        sync: false
      
      - key: ACCESS_TOKEN_TTL
        value: "15m" # 15 minutes
      
      - key: REFRESH_TOKEN_TTL
        value: "7d" # 7 days
      
      - key: COOKIE_SECRET
        generateValue: true
        sync: false
      
      # === CORS CONFIGURATION ===
      - key: CORS_ORIGIN
        value: "https://mindfulme-frontend.onrender.com" # ‚ö†Ô∏è UPDATE THIS with your actual frontend URL
      
      # === LOGGING & MONITORING ===
      - key: LOG_LEVEL
        value: "error" # Options: debug, info, warn, error
      
      - key: ENABLE_PERFORMANCE_MONITORING
        value: "true"
      
      # === OPTIONAL: EMAIL CONFIGURATION ===
      # Uncomment and configure if using email features
      # - key: SMTP_HOST
      #   value: smtp.sendgrid.net
      # - key: SMTP_PORT
      #   value: "587"
      # - key: SMTP_SECURE
      #   value: "false"
      # - key: SMTP_USER
      #   sync: false # Set manually in Render dashboard
      # - key: SMTP_PASS
      #   sync: false # Set manually in Render dashboard
      # - key: SMTP_FROM
      #   value: noreply@mindfulme.com
      
      # === OPTIONAL: ERROR TRACKING ===
      # - key: SENTRY_DSN
      #   sync: false # Set manually in Render dashboard
      # - key: SENTRY_ENVIRONMENT
      #   value: production
      
      # === OPTIONAL: RATE LIMITING ===
      # - key: RATE_LIMIT_WINDOW_MS
      #   value: "900000" # 15 minutes
      # - key: RATE_LIMIT_MAX_REQUESTS
      #   value: "100"
    
    # Health Check Configuration
    healthCheckPath: /health
    
    # Auto-deploy on push
    autoDeploy: true
    
    # Build Optimization - Only rebuild when these paths change
    buildFilter:
      paths:
        - backend/**
        - shared/**
        - package.json
        - package-lock.json
    
    # Scaling Configuration (Paid plans only)
    # Uncomment for auto-scaling on standard/pro plans
    # scaling:
    #   minInstances: 1
    #   maxInstances: 3
    #   targetMemoryPercent: 70
    #   targetCPUPercent: 70

  # ============================================================
  # FRONTEND STATIC SITE
  # ============================================================
  - type: web
    name: mindfulme-frontend
    runtime: static
    region: oregon
    plan: free # Static sites are always free on Render
    branch: main
    
    # Build Configuration
    buildCommand: |
      npm install &&
      npm run build:shared &&
      npm run build -w frontend &&
      echo "‚úÖ Frontend build complete" &&
      echo "üì¶ Bundle size:" && du -sh frontend/dist
    
    # Static site configuration
    staticPublishPath: frontend/dist
    
    # Enable preview deployments for pull requests
    pullRequestPreviewsEnabled: true
    
    # Environment Variables (available during build)
    envVars:
      # === API CONFIGURATION ===
      - key: VITE_API_URL
        value: "https://mindfulme-backend.onrender.com" # ‚ö†Ô∏è UPDATE THIS with your actual backend URL
      
      - key: VITE_NODE_ENV
        value: production
      
      - key: VITE_APP_VERSION
        value: "1.0.0"
      
      - key: VITE_APP_NAME
        value: "MindfulMe"
      
      # === OPTIONAL: ANALYTICS ===
      # - key: VITE_GA_TRACKING_ID
      #   value: G-XXXXXXXXXX
      # - key: VITE_SENTRY_DSN
      #   sync: false # Set manually in Render dashboard
      
      # === OPTIONAL: FEATURE FLAGS ===
      # - key: VITE_ENABLE_ANALYTICS
      #   value: "true"
      # - key: VITE_ENABLE_ERROR_TRACKING
      #   value: "true"
    
    # Security Headers
    headers:
      # Prevent clickjacking
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      
      # Prevent MIME type sniffing
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      
      # XSS Protection
      - path: /*
        name: X-XSS-Protection
        value: "1; mode=block"
      
      # Referrer Policy
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      
      # Content Security Policy (adjust as needed)
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://mindfulme-backend.onrender.com"
      
      # Cache static assets for 1 year
      - path: /assets/*
        name: Cache-Control
        value: "public, max-age=31536000, immutable"
      
      # Don't cache HTML
      - path: /index.html
        name: Cache-Control
        value: "no-cache, no-store, must-revalidate"
    
    # SPA Routing - Redirect all routes to index.html
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    
    # Build Optimization
    buildFilter:
      paths:
        - frontend/**
        - shared/**
        - package.json
        - package-lock.json

# ============================================================
# DATABASE CONFIGURATION
# ============================================================
databases:
  - name: mindfulme-postgres
    region: oregon # Must match backend region for best performance
    plan: free # Options: free (256MB, 90 days retention), starter ($7/mo, 1GB), standard ($20/mo, 10GB)
    databaseName: mindfulme_prod
    user: mindfulme
    
    # IP Allow List (empty = allow all)
    # For production, consider restricting to Render IPs only
    ipAllowList: []
    
    # PostgreSQL Version (paid plans only)
    # postgresMajorVersion: 15
    
    # Notes:
    # - Free tier: 256MB storage, 90 days retention, may expire after 90 days of inactivity
    # - Paid tiers: Daily backups, point-in-time recovery, always on
    # - Connection string automatically injected into backend as DATABASE_URL

# ============================================================
# DEPLOYMENT NOTES & CHECKLIST
# ============================================================
#
# üìã PRE-DEPLOYMENT CHECKLIST:
# ================================
#
# ‚òê 1. UPDATE URLS:
#    - Line 45: Update CORS_ORIGIN with actual frontend URL
#    - Line 123: Update VITE_API_URL with actual backend URL
#    - Line 201: Update Content-Security-Policy connect-src
#
# ‚òê 2. SET SECRETS IN RENDER DASHBOARD:
#    After initial deployment, verify auto-generated secrets:
#    - JWT_SECRET (auto-generated)
#    - JWT_REFRESH_SECRET (auto-generated)
#    - COOKIE_SECRET (auto-generated)
#    Optionally add:
#    - SMTP credentials (if using email)
#    - Sentry DSN (if using error tracking)
#    - Analytics keys (if using GA/Mixpanel)
#
# ‚òê 3. DATABASE MIGRATIONS:
#    First deployment will auto-create tables via Drizzle ORM
#    If manual migration needed:
#    - Connect to database via Render shell
#    - Run: npm run db:migrate -w backend
#
# ‚òê 4. CUSTOM DOMAIN (Optional):
#    - Add custom domain in Render dashboard
#    - Update CORS_ORIGIN and VITE_API_URL
#    - SSL certificates auto-provisioned
#
# ‚òê 5. MONITORING SETUP:
#    - Enable log tailing: render logs --service=mindfulme-backend
#    - Set up alerts in Render dashboard
#    - Configure health check notifications
#
# üöÄ DEPLOYMENT WORKFLOW:
# ================================
#
# INITIAL DEPLOYMENT:
# 1. Push render.yaml to main branch
# 2. Connect repository to Render
# 3. Render auto-creates all services from blueprint
# 4. Backend builds ‚Üí Runs migrations ‚Üí Starts server
# 5. Frontend builds ‚Üí Deploys static files
# 6. Database provisions ‚Üí Connection string injected
#
# SUBSEQUENT DEPLOYMENTS:
# 1. Push code to main branch
# 2. Auto-deploy triggers (if autoDeploy: true)
# 3. Only changed services rebuild (via buildFilter)
# 4. Zero-downtime deployment (paid plans)
#
# MANUAL DEPLOYMENT:
# 1. Go to Render dashboard
# 2. Select service
# 3. Click "Manual Deploy" ‚Üí Select branch/commit
#
# üîÑ ROLLBACK PROCEDURE:
# ================================
#
# ROLLBACK APPLICATION:
# 1. Render Dashboard ‚Üí Service ‚Üí "Deploys" tab
# 2. Find previous successful deployment
# 3. Click "Redeploy" on previous version
# 4. Confirm rollback
#
# ROLLBACK DATABASE (if migrations failed):
# 1. Access database shell: render shell --database=mindfulme-postgres
# 2. Check migration history: SELECT * FROM drizzle_migrations;
# 3. Manual rollback (if needed - backup first!)
# 4. Or restore from automatic backup (paid plans)
#
# EMERGENCY PROCEDURE:
# 1. Disable auto-deploy in service settings
# 2. Rollback to last known good deployment
# 3. Investigate logs: render logs --service=mindfulme-backend --tail
# 4. Fix issue in separate branch
# 5. Test with preview deployment
# 6. Re-enable auto-deploy after verification
#
# üìä MONITORING & LOGS:
# ================================
#
# VIEW LOGS:
# - CLI: render logs --service=mindfulme-backend --tail
# - Dashboard: Service ‚Üí Logs tab
# - Filter by severity: info, warn, error
#
# HEALTH CHECKS:
# - Backend: GET https://mindfulme-backend.onrender.com/health
# - Returns: { status: "ok", environment, database, timestamp }
# - Render auto-restarts if health check fails 3 times
#
# METRICS (Paid plans):
# - CPU usage
# - Memory usage  
# - Request count
# - Response time
# - Error rate
#
# üîê SECURITY NOTES:
# ================================
#
# SECRETS MANAGEMENT:
# - Never commit secrets to git
# - Use generateValue: true for auto-generated secrets
# - Use sync: false to prevent cross-service sharing
# - Rotate secrets periodically in Render dashboard
#
# DATABASE SECURITY:
# - Use SSL connections (automatic with Neon/Render)
# - Restrict IP allowlist in production
# - Enable connection pooling in application
# - Regular backups (automatic on paid plans)
#
# CORS SECURITY:
# - Update CORS_ORIGIN to exact frontend URL
# - Never use "*" in production
# - Include credentials if using cookies
#
# RATE LIMITING:
# - Implement in application code
# - Use Redis for distributed rate limiting (paid plans)
# - Configure per-endpoint limits
#
# ============================================================
